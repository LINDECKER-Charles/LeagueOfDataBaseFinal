name: CI Symfony

on:
  push:
    branches: [ dev ]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none
          extensions: sqlite3, pdo_sqlite   # ðŸ‘ˆ nÃ©cessaire pour SQLite

      - name: ðŸ§© Prepare .env files for test
        run: |
          mkdir -p var
          {
            echo "APP_ENV=test"
            echo "APP_DEBUG=1"
            echo "APP_SECRET=dev-secret"
            echo "DATABASE_URL=sqlite:///%kernel.project_dir%/var/test.db"
          } > .env
          cp .env .env.test

      - name: ðŸ’¾ Cache Composer
        uses: actions/cache@v3
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-php-

      - name: ðŸ“¦ Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: ðŸ” Lint YAML, Twig and Container
        run: |
          php bin/console lint:yaml config
          php bin/console lint:twig templates
          php bin/console lint:container

      - name: âœ… Run Tests
        run: php bin/phpunit

      - name: â¬†ï¸ Merge the tested commit into main (if tests passed)
        if: success() && github.ref == 'refs/heads/dev'
        working-directory: .
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch --all --prune

          # Se placer sur main Ã  jour
          git checkout main
          git reset --hard origin/main

          # Merger le COMMIT EXACT testÃ© par cette exÃ©cution
          git merge --no-ff --no-edit "${GITHUB_SHA}"

          # Pousser vers main
          git push origin HEAD:main 

  deploy:
    needs: test
    if: success()
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›¡ï¸ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

      - name: ðŸ” Add known_hosts
        run: |
          ssh-keyscan -H league-of-data-base.fr >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to production server
        run: |
          ssh root@league-of-data-base.fr <<'EOSSH'
            set -e
            cd /var/www/leagueofdatabase/LeagueOfDataBaseFinal/app

            # Toujours repartir clean
            git fetch --all --prune
            git reset --hard origin/main
            git clean -fd

            export APP_ENV=prod APP_DEBUG=0 COMPOSER_ALLOW_SUPERUSER=1
            composer install
            php bin/console cache:clear --env=prod
          EOSSH


